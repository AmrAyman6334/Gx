{% extends "base.html" %}

{% block title %}GX Bot - الإحصائيات المباشرة{% endblock %}

{% block content %}
<div class="stats-page">
    <div class="stats-container">
        <div class="page-header">
            <h1>📊 إحصائيات GX Bot</h1>
            <p style="color: #b9bbbe;">بيانات مباشرة من ملف <b>data.json</b></p>
            <div id="connection-status" class="status-indicator offline">
                <span class="status-dot"></span>
                <span>جاري تحميل البيانات...</span>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><span class="stat-icon">👥</span><div class="stat-value">—</div><div class="stat-label">إجمالي المستخدمين</div></div>
            <div class="stat-card"><span class="stat-icon">💰</span><div class="stat-value">—</div><div class="stat-label">إجمالي الكينتو</div></div>
            <div class="stat-card"><span class="stat-icon">🏦</span><div class="stat-value">—</div><div class="stat-label">الودائع</div></div>
            <div class="stat-card"><span class="stat-icon">👛</span><div class="stat-value">—</div><div class="stat-label">المحافظ</div></div>
            <div class="stat-card"><span class="stat-icon">📈</span><div class="stat-value">—</div><div class="stat-label">متوسط لكل مستخدم</div></div>
            <div class="stat-card"><span class="stat-icon">🌍</span><div class="stat-value">—</div><div class="stat-label">السيرفرات</div></div>
            <div class="stat-card"><span class="stat-icon">⭐</span><div class="stat-value">—</div><div class="stat-label">إجمالي الخبرة</div></div>
            <div class="stat-card"><span class="stat-icon">🏆</span><div class="stat-value">—</div><div class="stat-label">أعلى مستوى</div></div>
            <div class="stat-card"><span class="stat-icon">💎</span><div class="stat-value">—</div><div class="stat-label">إجمالي الثقة</div></div>
            <div class="stat-card"><span class="stat-icon">🎨</span><div class="stat-value">—</div><div class="stat-label">مجموع الخلفيات</div></div>
        </div>

        <div class="last-update">📅 آخر تحديث: —</div>

        <div class="refresh-section">
            <button class="btn-refresh" onclick="loadStats()">🔄 تحديث البيانات</button>
        </div>
    </div>
</div>

<style>
/* نفس التنسيقات السابقة */
.stats-page {min-height:100vh;padding:120px 2rem 4rem;background:linear-gradient(135deg,#0d0221 0%,#1a0b3d 100%);}
.stats-container{max-width:1400px;margin:0 auto;}
.page-header{text-align:center;margin-bottom:3rem;color:white;}
.page-header h1{font-size:3rem;background:linear-gradient(135deg,#00ffff 0%,#ff007f 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:1rem;}
.status-indicator{display:inline-flex;align-items:center;gap:0.5rem;padding:0.5rem 1.5rem;border-radius:50px;margin-top:1rem;}
.status-indicator.online{background:rgba(0,255,0,0.2);border:2px solid #00ff00;color:#00ff00;}
.status-indicator.offline{background:rgba(255,165,0,0.2);border:2px solid #ffa500;color:#ffa500;}
.status-dot{width:10px;height:10px;border-radius:50%;background:currentColor;}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:2rem;margin-bottom:2rem;}
.stat-card{background:rgba(13,2,33,0.8);border:2px solid rgba(0,255,255,0.3);border-radius:20px;padding:2rem;text-align:center;transition:all 0.3s;color:white;}
.stat-card:hover{border-color:#ff007f;transform:translateY(-5px);box-shadow:0 10px 30px rgba(255,0,127,0.3);}
.stat-icon{font-size:3rem;margin-bottom:1rem;display:block;}
.stat-value{font-size:2.5rem;font-weight:bold;background:linear-gradient(135deg,#00ffff 0%,#ff007f 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:0.5rem;}
.stat-label{color:#b9bbbe;font-size:1rem;}
.last-update{text-align:center;color:#72767d;margin:2rem 0;}
.refresh-section{text-align:center;}
.btn-refresh{background:linear-gradient(135deg,#00ffff 0%,#ff007f 100%);color:#0d0221;border:none;padding:1rem 2rem;border-radius:50px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all 0.3s;}
.btn-refresh:hover{transform:scale(1.05);box-shadow:0 10px 30px rgba(0,255,255,0.4);}
</style>

<script>
async function loadStats() {
    const statusEl = document.getElementById('connection-status');
    try {
        const res = await fetch("data.json");
        const data = await res.json();

        const users = Object.values(data.global_users || {});
        if(users.length === 0) throw new Error("لا يوجد مستخدمين في الملف");

        // حساب الإحصائيات
        const total_users = users.length;
        const total_kento = users.reduce((sum, u) => sum + (u.kento || 0), 0);
        const total_deposit = users.reduce((sum, u) => sum + (u.deposit || 0), 0);
        const total_currency = total_kento + total_deposit;
        const total_xp = users.reduce((sum, u) => sum + (u.xp || 0), 0);
        const avg_currency = Math.round(total_currency / total_users);
        const max_level = Math.max(...users.map(u => u.level || 0));
        const total_trust = users.reduce((sum, u) => sum + (u.trust || 0), 0);
        const total_backgrounds = users.reduce((sum, u) => sum + ((u.owned_backgrounds || []).length), 0);
        const total_guilds = data.guilds ? Object.keys(data.guilds).length : 1;

        // تحديث الحالة
        statusEl.className = 'status-indicator online';
        statusEl.innerHTML = '<span class="status-dot"></span><span>🟢 تم تحميل البيانات من data.json</span>';

        const cards = document.querySelectorAll(".stat-card");
        cards[0].querySelector(".stat-value").textContent = total_users.toLocaleString();
        cards[1].querySelector(".stat-value").textContent = total_currency.toLocaleString();
        cards[2].querySelector(".stat-value").textContent = total_deposit.toLocaleString();
        cards[3].querySelector(".stat-value").textContent = total_kento.toLocaleString();
        cards[4].querySelector(".stat-value").textContent = avg_currency.toLocaleString();
        cards[5].querySelector(".stat-value").textContent = total_guilds.toLocaleString();
        cards[6].querySelector(".stat-value").textContent = total_xp.toLocaleString();
        cards[7].querySelector(".stat-value").textContent = max_level.toLocaleString();
        cards[8].querySelector(".stat-value").textContent = total_trust.toLocaleString();
        cards[9].querySelector(".stat-value").textContent = total_backgrounds.toLocaleString();

        document.querySelector(".last-update").textContent = 
            "📅 آخر تحديث: " + new Date().toLocaleString("ar-EG");

    } catch(err) {
        console.error("⚠️ خطأ:", err);
        statusEl.className = 'status-indicator offline';
        statusEl.innerHTML = '<span class="status-dot"></span><span>⚠️ فشل تحميل data.json</span>';
    }
}

// تشغيل تلقائي
loadStats();
setInterval(loadStats, 60000);
</script>
{% endblock %}